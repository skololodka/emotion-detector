<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–≠–º–æ—Ü–∏—è ‚Äî –¥–µ—Ç–µ–∫—Ç–æ—Ä</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --border: #1e1e2e;
    --accent: #c8ff00;
    --accent2: #ff6b35;
    --text: #e8e8f0;
    --muted: #4a4a6a;
    --glow: rgba(200, 255, 0, 0.15);
  }

  body {
    font-family: 'Space Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
  }

  /* Grain overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.4;
  }

  .grid-bg {
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 48px 48px;
    opacity: 0.4;
    pointer-events: none;
  }

  header {
    padding: 32px 48px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
    position: relative;
    z-index: 10;
  }

  .logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 22px;
    letter-spacing: -0.5px;
  }

  .logo span {
    color: var(--accent);
    display: inline-block;
    transform: skewX(-8deg);
  }

  .status-pill {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 14px;
    border: 1px solid var(--border);
    border-radius: 100px;
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }

  .status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--muted);
    transition: background 0.3s, box-shadow 0.3s;
  }

  .status-dot.active {
    background: var(--accent);
    box-shadow: 0 0 8px var(--accent);
    animation: pulse-dot 2s ease-in-out infinite;
  }

  @keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .main {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 0;
    min-height: calc(100vh - 89px);
    position: relative;
    z-index: 10;
  }

  /* Camera section */
  .camera-section {
    padding: 48px;
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .section-label {
    font-size: 10px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .section-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .video-wrapper {
    position: relative;
    aspect-ratio: 4/3;
    max-width: 640px;
    border: 1px solid var(--border);
    overflow: hidden;
    background: var(--surface);
  }

  /* Corner decorations */
  .video-wrapper::before,
  .video-wrapper::after {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    z-index: 5;
  }

  .video-wrapper::before {
    top: 0; left: 0;
    border-top: 2px solid var(--accent);
    border-left: 2px solid var(--accent);
  }

  .video-wrapper::after {
    bottom: 0; right: 0;
    border-bottom: 2px solid var(--accent);
    border-right: 2px solid var(--accent);
  }

  .corner-tr, .corner-bl {
    position: absolute;
    width: 20px;
    height: 20px;
    z-index: 5;
  }

  .corner-tr { top: 0; right: 0; border-top: 2px solid var(--accent); border-right: 2px solid var(--accent); }
  .corner-bl { bottom: 0; left: 0; border-bottom: 2px solid var(--accent); border-left: 2px solid var(--accent); }

  video, canvas {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  canvas {
    position: absolute;
    top: 0; left: 0;
    display: none;
  }

  .scan-line {
    position: absolute;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    top: -2px;
    opacity: 0;
    transition: opacity 0.3s;
    box-shadow: 0 0 12px var(--accent);
    z-index: 4;
  }

  .scan-line.scanning {
    opacity: 1;
    animation: scan 2s ease-in-out;
  }

  @keyframes scan {
    0% { top: 0%; }
    100% { top: 100%; }
  }

  .placeholder {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    color: var(--muted);
    font-size: 13px;
  }

  .placeholder-icon {
    font-size: 48px;
    opacity: 0.3;
  }

  .controls {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .btn {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 12px 24px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text);
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }

  .btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--accent);
    transform: translateX(-100%);
    transition: transform 0.2s;
    z-index: 0;
  }

  .btn:hover::before { transform: translateX(0); }
  .btn:hover { color: var(--bg); border-color: var(--accent); }
  .btn span { position: relative; z-index: 1; }

  .btn-primary {
    background: var(--accent);
    color: var(--bg);
    border-color: var(--accent);
    font-weight: 700;
  }

  .btn-primary::before { background: #fff; }
  .btn-primary:hover { color: var(--bg); }

  .btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .btn:disabled::before { display: none; }
  .btn:disabled:hover { color: var(--text); border-color: var(--border); }

  .btn-danger {
    border-color: var(--accent2);
    color: var(--accent2);
  }

  .btn-danger::before { background: var(--accent2); }
  .btn-danger:hover { color: white; }

  .auto-mode {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border: 1px solid var(--border);
    background: var(--surface);
    font-size: 12px;
    color: var(--muted);
  }

  .toggle {
    width: 36px;
    height: 20px;
    background: var(--border);
    border-radius: 100px;
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
    flex-shrink: 0;
  }

  .toggle.on { background: var(--accent); }

  .toggle::after {
    content: '';
    position: absolute;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: white;
    top: 3px;
    left: 3px;
    transition: transform 0.2s;
  }

  .toggle.on::after { transform: translateX(16px); }

  /* Right panel */
  .results-section {
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .results-header {
    padding: 24px 32px;
    border-bottom: 1px solid var(--border);
  }

  .results-header h2 {
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    margin-top: 8px;
  }

  /* Big emotion display */
  .emotion-hero {
    padding: 40px 32px;
    border-bottom: 1px solid var(--border);
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    position: relative;
    overflow: hidden;
  }

  .emotion-hero::before {
    content: attr(data-emotion);
    position: absolute;
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 96px;
    color: var(--glow);
    top: 50%;
    left: -10px;
    transform: translateY(-50%);
    white-space: nowrap;
    pointer-events: none;
    text-transform: uppercase;
    letter-spacing: -4px;
    line-height: 1;
    transition: color 0.3s;
  }

  .emotion-emoji {
    font-size: 56px;
    position: relative;
    z-index: 1;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: inline-block;
    line-height: 1;
  }

  .emotion-emoji.pop {
    animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  @keyframes pop {
    0% { transform: scale(1); }
    50% { transform: scale(1.4); }
    100% { transform: scale(1); }
  }

  .emotion-name {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 28px;
    position: relative;
    z-index: 1;
    margin-top: 8px;
    transition: all 0.3s;
    text-transform: uppercase;
    letter-spacing: -0.5px;
  }

  .emotion-name.has-emotion {
    color: var(--accent);
  }

  .confidence-bar-wrap {
    margin-top: 12px;
    position: relative;
    z-index: 1;
  }

  .confidence-label {
    font-size: 10px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 6px;
    display: flex;
    justify-content: space-between;
  }

  .confidence-bar {
    height: 3px;
    background: var(--border);
    position: relative;
    overflow: hidden;
  }

  .confidence-fill {
    height: 100%;
    background: var(--accent);
    width: 0%;
    transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 0 8px var(--accent);
  }

  /* Details */
  .details-scroll {
    flex: 1;
    overflow-y: auto;
    padding: 24px 32px;
  }

  .details-scroll::-webkit-scrollbar {
    width: 4px;
  }

  .details-scroll::-webkit-scrollbar-track { background: transparent; }
  .details-scroll::-webkit-scrollbar-thumb { background: var(--border); }

  .analysis-text {
    font-size: 13px;
    line-height: 1.8;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    white-space: pre-wrap;
    transition: opacity 0.3s;
  }

  .analysis-text.loading {
    opacity: 0.5;
  }

  .analysis-text.loaded {
    color: var(--text);
  }

  /* History */
  .history-section {
    padding: 0 32px 24px;
    border-top: 1px solid var(--border);
    margin-top: auto;
  }

  .history-label {
    font-size: 10px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--muted);
    padding: 16px 0 12px;
  }

  .history-chips {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .chip {
    padding: 4px 10px;
    border: 1px solid var(--border);
    font-size: 11px;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 4px;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Typing animation */
  .typing-cursor {
    display: inline-block;
    width: 2px;
    height: 1em;
    background: var(--accent);
    vertical-align: text-bottom;
    animation: blink 1s step-end infinite;
  }

  @keyframes blink {
    50% { opacity: 0; }
  }

  /* Loading spinner */
  .spinner {
    display: none;
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .spinner.visible { display: inline-block; }

  /* Counter */
  .counter {
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.05em;
  }

  .counter span {
    color: var(--accent);
    font-weight: 700;
  }

  /* Flash overlay when capturing */
  .flash {
    position: absolute;
    inset: 0;
    background: white;
    opacity: 0;
    pointer-events: none;
    z-index: 6;
  }

  .flash.snap {
    animation: flash 0.3s ease;
  }

  @keyframes flash {
    0% { opacity: 0.6; }
    100% { opacity: 0; }
  }

  @media (max-width: 768px) {
    .main { grid-template-columns: 1fr; }
    header { padding: 20px 24px; }
    .camera-section { padding: 24px; }
    .results-section { min-height: 400px; }
  }
</style>
</head>
<body>

<div class="grid-bg"></div>

<header>
  <div class="logo">emo<span>SCAN</span></div>
  <div class="status-pill">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">–æ–∂–∏–¥–∞–Ω–∏–µ</span>
  </div>
</header>

<div class="main">
  <!-- Camera -->
  <div class="camera-section">
    <div class="section-label">–≤—Ö–æ–¥—è—â–∏–π –ø–æ—Ç–æ–∫</div>

    <div class="video-wrapper" id="videoWrapper">
      <div class="corner-tr"></div>
      <div class="corner-bl"></div>
      <div class="scan-line" id="scanLine"></div>
      <div class="flash" id="flash"></div>
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas"></canvas>
      <div class="placeholder" id="placeholder">
        <div class="placeholder-icon">‚óâ</div>
        <div>–Ω–∞–∂–º–∏ ¬´–≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É¬ª</div>
      </div>
    </div>

    <div class="controls">
      <button class="btn btn-primary" id="startBtn" onclick="startCamera()">
        <span>–≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</span>
      </button>
      <button class="btn btn-danger" id="stopBtn" onclick="stopCamera()" disabled>
        <span>—Å—Ç–æ–ø</span>
      </button>
      <button class="btn" id="analyzeBtn" onclick="analyzeEmotion()" disabled>
        <span>–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</span>
      </button>
    </div>

    <div class="auto-mode">
      <div class="toggle" id="autoToggle" onclick="toggleAuto()"></div>
      <span>–ê–≤—Ç–æ-—Ä–µ–∂–∏–º (–∫–∞–∂–¥—ã–µ 5 —Å–µ–∫)</span>
      <div class="spinner" id="spinner"></div>
    </div>
  </div>

  <!-- Results -->
  <div class="results-section">
    <div class="results-header">
      <div class="section-label">–∞–Ω–∞–ª–∏–∑</div>
      <h2>–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —ç–º–æ—Ü–∏–π</h2>
    </div>

    <div class="emotion-hero" id="emotionHero" data-emotion="">
      <div class="emotion-emoji" id="emotionEmoji">‚óå</div>
      <div class="emotion-name" id="emotionName">–û–∂–∏–¥–∞—é –∫–∞–¥—Ä...</div>
      <div class="confidence-bar-wrap" id="confidenceWrap" style="display:none">
        <div class="confidence-label">
          <span>—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</span>
          <span id="confidenceVal">0%</span>
        </div>
        <div class="confidence-bar">
          <div class="confidence-fill" id="confidenceFill"></div>
        </div>
      </div>
    </div>

    <div class="details-scroll">
      <div class="analysis-text" id="analysisText">–í–∫–ª—é—á–∏ –∫–∞–º–µ—Ä—É –∏ –Ω–∞–∂–º–∏ ¬´–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å¬ª, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å —Å–≤–æ—é —ç–º–æ—Ü–∏—é. –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –≤–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-—Ä–µ–∂–∏–º –¥–ª—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.</div>
    </div>

    <div class="history-section" id="historySection" style="display:none">
      <div class="history-label">–∏—Å—Ç–æ—Ä–∏—è</div>
      <div class="history-chips" id="historyChips"></div>
    </div>
  </div>
</div>

<script>
let stream = null;
let autoInterval = null;
let isAnalyzing = false;
let autoMode = false;
let analysisCount = 0;
let history = [];

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const EMOTIONS = {
  —Ä–∞–¥–æ—Å—Ç—å: { emoji: 'üòÑ', en: 'Joy' },
  —Å—á–∞—Å—Ç—å–µ: { emoji: 'üòä', en: 'Happiness' },
  –≥—Ä—É—Å—Ç—å: { emoji: 'üò¢', en: 'Sadness' },
  –∑–ª–æ—Å—Ç—å: { emoji: 'üò†', en: 'Anger' },
  —É–¥–∏–≤–ª–µ–Ω–∏–µ: { emoji: 'üò≤', en: 'Surprise' },
  —Å—Ç—Ä–∞—Ö: { emoji: 'üò®', en: 'Fear' },
  –æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ: { emoji: 'ü§¢', en: 'Disgust' },
  –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π: { emoji: 'üòê', en: 'Neutral' },
  —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ: { emoji: 'üòå', en: 'Calm' },
  —Å–º—É—â–µ–Ω–∏–µ: { emoji: 'üò≥', en: 'Embarrassment' },
  —Å–∫—É–∫–∞: { emoji: 'üòí', en: 'Boredom' },
  –∑–∞–¥—É–º—á–∏–≤–æ—Å—Ç—å: { emoji: 'ü§î', en: 'Thoughtful' },
  —É—Å—Ç–∞–ª–æ—Å—Ç—å: { emoji: 'üò¥', en: 'Tired' },
  –≤–æ—Å—Ö–∏—â–µ–Ω–∏–µ: { emoji: 'ü§©', en: 'Amazement' },
  —Ç—Ä–µ–≤–æ–≥–∞: { emoji: 'üòü', en: 'Anxiety' },
};

async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 }, audio: false });
    video.srcObject = stream;
    document.getElementById('placeholder').style.display = 'none';
    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;
    document.getElementById('analyzeBtn').disabled = false;
    setStatus('–∞–∫—Ç–∏–≤–Ω–∞', true);
  } catch (e) {
    setStatus('–æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞', false);
    document.getElementById('analysisText').textContent = '‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –†–∞–∑—Ä–µ—à–∏ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
  }
}

function stopCamera() {
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  if (autoInterval) { clearInterval(autoInterval); autoInterval = null; }
  autoMode = false;
  document.getElementById('autoToggle').classList.remove('on');
  video.srcObject = null;
  document.getElementById('placeholder').style.display = 'flex';
  document.getElementById('startBtn').disabled = false;
  document.getElementById('stopBtn').disabled = true;
  document.getElementById('analyzeBtn').disabled = true;
  setStatus('–æ–∂–∏–¥–∞–Ω–∏–µ', false);
}

function toggleAuto() {
  if (!stream) return;
  autoMode = !autoMode;
  document.getElementById('autoToggle').classList.toggle('on', autoMode);
  if (autoMode) {
    analyzeEmotion();
    autoInterval = setInterval(analyzeEmotion, 5000);
  } else {
    if (autoInterval) { clearInterval(autoInterval); autoInterval = null; }
  }
}

function captureFrame() {
  canvas.width = video.videoWidth || 640;
  canvas.height = video.videoHeight || 480;
  ctx.drawImage(video, 0, 0);
  return canvas.toDataURL('image/jpeg', 0.85).split(',')[1];
}

async function analyzeEmotion() {
  if (isAnalyzing || !stream) return;
  isAnalyzing = true;

  // Visual feedback
  document.getElementById('flash').classList.add('snap');
  setTimeout(() => document.getElementById('flash').classList.remove('snap'), 300);

  const scanLine = document.getElementById('scanLine');
  scanLine.classList.add('scanning');
  setTimeout(() => scanLine.classList.remove('scanning'), 2000);

  document.getElementById('spinner').classList.add('visible');
  document.getElementById('analyzeBtn').disabled = true;
  setAnalysisText('–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...', true);

  try {
    const imageData = captureFrame();

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        messages: [{
          role: 'user',
          content: [
            {
              type: 'image',
              source: { type: 'base64', media_type: 'image/jpeg', data: imageData }
            },
            {
              type: 'text',
              text: `–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—é —ç–º–æ—Ü–∏–π. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –ª–∏—Ü–∞ –Ω–∞ —ç—Ç–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏.

–û—Ç–≤–µ—Ç—å –°–¢–†–û–ì–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON (–±–µ–∑ markdown, –±–µ–∑ \`\`\`):
{
  "emotion": "–Ω–∞–∑–≤–∞–Ω–∏–µ —ç–º–æ—Ü–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º",
  "confidence": —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 100,
  "description": "3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ —Ç–æ–º, —á—Ç–æ —Ç—ã –≤–∏–¥–∏—à—å: –º–∏–º–∏–∫–∞, –ø–æ–ª–æ–∂–µ–Ω–∏–µ –±—Ä–æ–≤–µ–π, —É–≥–æ–ª–∫–æ–≤ —Ä—Ç–∞, –æ–±—â–µ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ. –ü–∏—à–∏ –∂–∏–≤–æ –∏ —Ç–æ—á–Ω–æ.",
  "tips": "–∫–æ—Ä–æ—Ç–∫–∏–π —Å–æ–≤–µ—Ç –∏–ª–∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ"
}

–ï—Å–ª–∏ –ª–∏—Ü–∞ –Ω–µ—Ç ‚Äî –≤–µ—Ä–Ω–∏ emotion: "–Ω–µ—Ç –ª–∏—Ü–∞".`
            }
          ]
        }]
      })
    });

    const data = await response.json();
    const raw = data.content.map(b => b.text || '').join('');
    const clean = raw.replace(/```json|```/g, '').trim();
    const result = JSON.parse(clean);

    displayEmotion(result);
    addToHistory(result.emotion);
    analysisCount++;

  } catch (err) {
    console.error(err);
    setAnalysisText('‚ö† –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞. –ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.');
  }

  document.getElementById('spinner').classList.remove('visible');
  document.getElementById('analyzeBtn').disabled = false;
  isAnalyzing = false;
}

function displayEmotion(result) {
  const emotion = result.emotion.toLowerCase();
  const match = Object.keys(EMOTIONS).find(k => emotion.includes(k));
  const meta = match ? EMOTIONS[match] : { emoji: 'üîç', en: '' };

  const emojiEl = document.getElementById('emotionEmoji');
  const nameEl = document.getElementById('emotionName');
  const heroEl = document.getElementById('emotionHero');

  emojiEl.classList.remove('pop');
  void emojiEl.offsetWidth;
  emojiEl.textContent = meta.emoji;
  emojiEl.classList.add('pop');

  nameEl.textContent = result.emotion.toUpperCase();
  nameEl.className = 'emotion-name has-emotion';
  heroEl.setAttribute('data-emotion', result.emotion.toUpperCase());

  // Confidence
  const confWrap = document.getElementById('confidenceWrap');
  confWrap.style.display = 'block';
  document.getElementById('confidenceVal').textContent = result.confidence + '%';
  setTimeout(() => {
    document.getElementById('confidenceFill').style.width = result.confidence + '%';
  }, 50);

  // Text
  const text = `${result.description}\n\nüí° ${result.tips}`;
  typeText(text);

  setStatus('–∞–∫—Ç–∏–≤–Ω–∞ ¬∑ –∞–Ω–∞–ª–∏–∑ #' + analysisCount, true);
}

function typeText(text) {
  const el = document.getElementById('analysisText');
  el.innerHTML = '';
  el.className = 'analysis-text loaded';
  let i = 0;
  const interval = setInterval(() => {
    if (i >= text.length) { clearInterval(interval); return; }
    el.textContent += text[i];
    i++;
  }, 12);
}

function setAnalysisText(text, loading = false) {
  const el = document.getElementById('analysisText');
  el.textContent = text;
  el.className = 'analysis-text' + (loading ? ' loading' : '');
}

function addToHistory(emotion) {
  const meta = Object.keys(EMOTIONS).find(k => emotion.toLowerCase().includes(k));
  const emoji = meta ? EMOTIONS[meta].emoji : 'üîç';
  history.unshift({ emotion, emoji });
  if (history.length > 8) history.pop();

  const section = document.getElementById('historySection');
  const chips = document.getElementById('historyChips');
  section.style.display = 'block';
  chips.innerHTML = '';
  history.forEach(h => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.innerHTML = `${h.emoji} <span>${h.emotion}</span>`;
    chips.appendChild(chip);
  });
}

function setStatus(text, active) {
  document.getElementById('statusText').textContent = text;
  document.getElementById('statusDot').className = 'status-dot' + (active ? ' active' : '');
}
</script>
</body>
</html>
